@using WordSearchSolver.Domain.ValueObjects
@using static WordSearchSolver.Web.Pages.Index

<div class="grid-container">
    @if (Letters == null)
    {
        <div class="grid-placeholder">
            <p>Upload a word search puzzle to begin</p>
        </div>
    }
    else
    {
        <div class="grid-wrapper">
            <svg class="circle-overlay" viewBox="0 0 @(GetCols() * 40) @(GetRows() * 40)">
                @if (ShowCircles)
                {
                    @foreach (var circle in Circles)
                    {
                        var (cx, cy, width, height, angle) = CalculateStadium(circle.Start, circle.End);
                        var rx = height / 2; // Rounded corners = half height for stadium shape
                        <rect
                            x="@(-width / 2)"
                            y="@(-height / 2)"
                            width="@width"
                            height="@height"
                            rx="@rx"
                            ry="@rx"
                            transform="translate(@cx, @cy) rotate(@angle)"
                            fill="none"
                            stroke="@circle.Color"
                            stroke-width="2"
                            class="answer-circle"
                            @onmouseenter="() => HandleCircleEnter(circle.Answer)"
                            @onmouseleave="HandleCircleLeave" />
                    }
                }
            </svg>

            <div class="letter-grid" style="grid-template-columns: repeat(@GetCols(), 1fr);">
                @for (var row = 0; row < GetRows(); row++)
                {
                    @for (var col = 0; col < GetCols(); col++)
                    {
                        var r = row;
                        var c = col;
                        var highlightColor = GetHighlightColor(r, c);
                        <div class="grid-cell @(highlightColor != null ? "highlighted" : "")"
                             style="@(highlightColor != null ? $"background-color: {highlightColor};" : "")">
                            @Letters[r, c]
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public char[,]? Letters { get; set; }
    [Parameter] public List<HighlightedCell> HighlightedCells { get; set; } = new();
    [Parameter] public List<CircleData> Circles { get; set; } = new();
    [Parameter] public bool ShowCircles { get; set; }
    [Parameter] public EventCallback<string?> OnCircleHover { get; set; }

    private int GetRows() => Letters?.GetLength(0) ?? 0;
    private int GetCols() => Letters?.GetLength(1) ?? 0;

    private string? GetHighlightColor(int row, int col)
    {
        var cell = HighlightedCells.FirstOrDefault(c => c.Row == row && c.Col == col);
        return cell?.Color;
    }

    private (double cx, double cy, double width, double height, double angle) CalculateStadium(
        GridCoordinate start, GridCoordinate end)
    {
        const double cellSize = 40;
        const double padding = 8;

        var startX = start.Col * cellSize + cellSize / 2;
        var startY = start.Row * cellSize + cellSize / 2;
        var endX = end.Col * cellSize + cellSize / 2;
        var endY = end.Row * cellSize + cellSize / 2;

        var cx = (startX + endX) / 2;
        var cy = (startY + endY) / 2;

        var dx = endX - startX;
        var dy = endY - startY;
        var length = Math.Sqrt(dx * dx + dy * dy);

        var width = length + cellSize + padding;
        var height = cellSize + padding;

        var angle = Math.Atan2(dy, dx) * 180 / Math.PI;

        return (cx, cy, width, height, angle);
    }

    private async Task HandleCircleEnter(string answer)
    {
        await OnCircleHover.InvokeAsync(answer);
    }

    private async Task HandleCircleLeave()
    {
        await OnCircleHover.InvokeAsync(null);
    }
}
