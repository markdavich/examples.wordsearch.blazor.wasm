@namespace WordSearch.Web.Components
@inject IJSRuntime JS

<div class="tooltip-wrapper"
     @onmouseenter="ShowTooltip"
     @onmouseleave="StartHideTimer"
     @ref="_wrapperRef">
    @ChildContent
    @if (_visible)
    {
        <div class="tooltip-popup @_positionClass"
             style="@_positionStyle"
             @onmouseenter="CancelHideTimer"
             @onmouseleave="StartHideTimer">
            <div class="tooltip-content">
                <strong class="tooltip-title">@Title</strong>
                <p class="tooltip-text">@Description</p>
                @if (!string.IsNullOrEmpty(GuideLink))
                {
                    <a href="@GuideLink" target="_blank" class="tooltip-link">
                        Learn more in User Guide
                    </a>
                }
            </div>
            <div class="tooltip-arrow"></div>
        </div>
    }
</div>

@code {
    private const int TooltipWidth = 260;
    private const int TooltipHeight = 120; // Approximate height
    private const int Offset = 10;

    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public string Description { get; set; } = "";
    [Parameter] public string GuideLink { get; set; } = "";
    [Parameter] public string Position { get; set; } = "top";

    private bool _visible;
    private System.Timers.Timer? _hideTimer;
    private ElementReference _wrapperRef;
    private string _positionClass = "";
    private string _positionStyle = "";

    protected override void OnInitialized()
    {
        _hideTimer = new System.Timers.Timer(300);
        _hideTimer.AutoReset = false;
        _hideTimer.Elapsed += async (s, e) => await HideTooltip();
    }

    private async Task ShowTooltip()
    {
        CancelHideTimer();
        _visible = true;
        await CalculateFixedPosition();
    }

    private async Task CalculateFixedPosition()
    {
        try
        {
            var bounds = await JS.InvokeAsync<BoundingRect>("getTooltipBounds", _wrapperRef);
            if (bounds == null) return;

            var centerX = (bounds.Left + bounds.Right) / 2;
            var centerY = (bounds.Top + bounds.Bottom) / 2;

            // Determine actual position (may flip if would go off screen)
            var actualPosition = Position;

            // Check if preferred position would go off screen and flip if needed
            if (Position == "top" && bounds.Top < TooltipHeight + Offset)
                actualPosition = "bottom";
            else if (Position == "bottom" && bounds.Bottom > bounds.WindowHeight - TooltipHeight - Offset)
                actualPosition = "top";
            else if (Position == "left" && bounds.Left < TooltipWidth + Offset)
                actualPosition = "right";
            else if (Position == "right" && bounds.Right > bounds.WindowWidth - TooltipWidth - Offset)
                actualPosition = "left";

            // Calculate fixed position based on actual position
            double top = 0, left = 0;

            switch (actualPosition)
            {
                case "top":
                    top = bounds.Top - Offset;
                    left = centerX - (TooltipWidth / 2);
                    break;
                case "bottom":
                    top = bounds.Bottom + Offset;
                    left = centerX - (TooltipWidth / 2);
                    break;
                case "left":
                    top = centerY;
                    left = bounds.Left - TooltipWidth - Offset;
                    break;
                case "right":
                    top = centerY;
                    left = bounds.Right + Offset;
                    break;
            }

            // Clamp to screen bounds
            left = Math.Max(8, Math.Min(left, bounds.WindowWidth - TooltipWidth - 8));
            if (actualPosition == "top")
                top = Math.Max(8, top);
            else if (actualPosition == "bottom")
                top = Math.Min(top, bounds.WindowHeight - TooltipHeight - 8);

            _positionClass = $"tooltip-{actualPosition}";
            _positionStyle = $"top: {top.ToString(System.Globalization.CultureInfo.InvariantCulture)}px; left: {left.ToString(System.Globalization.CultureInfo.InvariantCulture)}px;";

            StateHasChanged();
        }
        catch
        {
            // Fallback - no positioning
            _positionClass = $"tooltip-{Position}";
            _positionStyle = "";
        }
    }

    private void StartHideTimer()
    {
        _hideTimer?.Stop();
        _hideTimer?.Start();
    }

    private void CancelHideTimer()
    {
        _hideTimer?.Stop();
    }

    private async Task HideTooltip()
    {
        _visible = false;
        _positionClass = "";
        _positionStyle = "";
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _hideTimer?.Dispose();
    }

    private class BoundingRect
    {
        public double Top { get; set; }
        public double Left { get; set; }
        public double Right { get; set; }
        public double Bottom { get; set; }
        public double WindowWidth { get; set; }
        public double WindowHeight { get; set; }
    }
}
