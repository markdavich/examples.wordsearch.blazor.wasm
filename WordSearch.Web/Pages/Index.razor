@page "/"
@using WordSearch.Application.Interfaces
@using WordSearch.Domain.Entities
@using WordSearch.Domain.ValueObjects
@using WordSearch.Web.Components
@using WordSearch.Web.Services
@implements IDisposable

@inject PuzzleService PuzzleService

<div class="content-container">
    <div class="left-panel">
        <div class="controls-column">
            <div class="button-row">
                <Tooltip Title="Clear Highlights"
                         Description="Remove all colored highlighting from the grid and reset selections."
                         GuideLink="guide/features.html#clear-highlights"
                         Position="bottom">
                    <button class="action-btn" @onclick="ClearHighlights">Clear Highlights</button>
                </Tooltip>
                <Tooltip Title="Circle Answers"
                         Description="Toggle stadium-shaped circles around all found words. Hover over circles to highlight individual answers."
                         GuideLink="guide/features.html#circle-overlay"
                         Position="bottom">
                    <button class="action-btn" @onclick="ToggleCircles">Circle Answers</button>
                </Tooltip>
            </div>

            <WordsToFind
                Words="@_words"
                SelectedWord="@_selectedWord"
                OnWordSelected="HandleWordSelected" />
        </div>

        <div class="answers-column">
            <Answers
                Matches="@_matches"
                HighlightedAnswers="@_highlightedAnswers"
                ScrollToWord="@_selectedWord"
                OnAnswerSelected="HandleAnswerSelected" />
        </div>
    </div>

    <div class="grid-panel">
        <WordSearchGrid
            Letters="@_letters"
            HighlightedCells="@_highlightedCells"
            Circles="@_circleData"
            ShowCircles="@_showCircles"
            OnCircleHover="HandleCircleHover" />
    </div>
</div>

@code {
    [Inject] private IWordFinder WordFinder { get; set; } = default!;

    private char[,]? _letters;
    private List<string> _words = new();
    private List<Match> _matches = new();
    private Dictionary<string, string> _normalizedToOriginal = new();
    private string? _selectedWord;
    private Dictionary<string, string> _highlightedAnswers = new();
    private List<HighlightedCell> _highlightedCells = new();
    private bool _showCircles = false;
    private List<CircleData> _circleData = new();
    private string? _hoveredCircle;

    private static readonly string[] ColorPalette =
    {
        "#FF6B6B", "#FF9F43", "#FECA57", "#48DBFB",
        "#1DD1A1", "#5F27CD", "#FF6B9D", "#00D2D3"
    };

    protected override void OnInitialized()
    {
        PuzzleService.OnPuzzleLoaded += HandlePuzzleLoaded;
    }

    public void Dispose()
    {
        PuzzleService.OnPuzzleLoaded -= HandlePuzzleLoaded;
    }

    private void HandlePuzzleLoaded(string content)
    {
        try
        {
            var puzzle = WordSearchPuzzle.Parse(content);
            _letters = puzzle.Letters;
            _words = puzzle.Words.OrderBy(w => w, StringComparer.OrdinalIgnoreCase).ToList();

            // Create mapping from normalized (no spaces) to original words
            _normalizedToOriginal = _words.ToDictionary(
                w => w.Replace(" ", "").ToUpperInvariant(),
                w => w,
                StringComparer.OrdinalIgnoreCase);

            // Search using normalized words (spaces removed)
            var normalizedWords = _words.Select(w => w.Replace(" ", "")).ToList();
            _matches = WordFinder.FindWords(_letters, normalizedWords)
                .OrderBy(m => m.Word, StringComparer.OrdinalIgnoreCase)
                .ToList();

            ClearHighlights();
            _circleData = BuildCircleData();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing file: {ex.Message}");
        }
    }

    private void HandleWordSelected(string word)
    {
        ClearHighlights();
        _selectedWord = word.ToUpperInvariant().Replace(" ", "");

        var matchingAnswers = _matches
            .Where(m => m.Word.Equals(_selectedWord, StringComparison.OrdinalIgnoreCase))
            .ToList();

        for (var i = 0; i < matchingAnswers.Count; i++)
        {
            var color = ColorPalette[i % ColorPalette.Length];
            _highlightedAnswers[matchingAnswers[i].ToString()] = color;
        }

        UpdateHighlightedCells();
    }

    private void HandleAnswerSelected(Match answer)
    {
        ClearHighlights();
        _selectedWord = answer.Word;
        var color = ColorPalette[0];
        _highlightedAnswers[answer.ToString()] = color;
        UpdateHighlightedCells();
    }

    private void ClearHighlights()
    {
        _selectedWord = null;
        _highlightedAnswers.Clear();
        _highlightedCells.Clear();
        _hoveredCircle = null;
    }

    private void ToggleCircles()
    {
        _showCircles = !_showCircles;
        if (!_showCircles)
        {
            _hoveredCircle = null;
            ClearHighlights();
        }
    }

    private void HandleCircleHover(string? answer)
    {
        _hoveredCircle = answer;

        // Clear previous hover highlights
        _highlightedAnswers.Clear();
        _selectedWord = null;

        if (answer != null)
        {
            var match = _matches.FirstOrDefault(m => m.ToString() == answer);
            if (match != null)
            {
                // Highlight the answer
                var idx = _matches.FindIndex(m => m.ToString() == answer);
                var color = ColorPalette[idx % ColorPalette.Length];
                _highlightedAnswers[answer] = color;

                // Highlight the word (get original with spaces)
                _selectedWord = GetDisplayWord(match.Word);
            }
        }
    }

    private void UpdateHighlightedCells()
    {
        _highlightedCells.Clear();

        foreach (var (answer, color) in _highlightedAnswers)
        {
            var match = _matches.FirstOrDefault(m => m.ToString() == answer);
            if (match != null)
            {
                foreach (var coord in match.GetPath())
                {
                    _highlightedCells.Add(new HighlightedCell(coord.Row, coord.Col, color));
                }
            }
        }
    }

    private List<CircleData> BuildCircleData()
    {
        var result = new List<CircleData>();

        for (var i = 0; i < _matches.Count; i++)
        {
            var match = _matches[i];
            var color = ColorPalette[i % ColorPalette.Length];
            // Get original word with spaces for display
            var displayWord = _normalizedToOriginal.TryGetValue(match.Word, out var original)
                ? original
                : match.Word;
            result.Add(new CircleData(
                match.ToString(),
                displayWord,
                match.Start,
                match.End,
                color
            ));
        }

        return result;
    }

    private string GetDisplayWord(string normalizedWord)
    {
        return _normalizedToOriginal.TryGetValue(normalizedWord, out var original)
            ? original
            : normalizedWord;
    }

    public record HighlightedCell(int Row, int Col, string Color);
    public record CircleData(string Answer, string Word, GridCoordinate Start, GridCoordinate End, string Color);
}
